<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Franz`s blog</title>
  <icon>https://www.gravatar.com/avatar/2e830db9ff9a923cf7910f87dbcb3f90</icon>
  
  <link href="https://blog.frzli.top/atom.xml" rel="self"/>
  
  <link href="https://blog.frzli.top/"/>
  <updated>2023-05-19T03:22:12.693Z</updated>
  <id>https://blog.frzli.top/</id>
  
  <author>
    <name>Franz li</name>
    <email>franzli2003@163.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>sse 的原理以及java下的简单实现</title>
    <link href="https://blog.frzli.top/2023/05/19/sse%20%E7%9A%84%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8Ajava%E4%B8%8B%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/"/>
    <id>https://blog.frzli.top/2023/05/19/sse%20%E7%9A%84%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8Ajava%E4%B8%8B%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/</id>
    <published>2023-05-19T02:39:27.000Z</published>
    <updated>2023-05-19T03:22:12.693Z</updated>
    
    <content type="html"><![CDATA[<p>前段时间看到gpt返回时的部分输出的效果，觉得很有意思，所以研究了下是怎么实现的。</p><p>主要是通过sse（Server-Sent Events）技术实现的这种效果</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>SSE（Server-Sent Events）和WebSocket都是用于实现服务器和客户端之间的实时通信的技术，但它们有一些区别。</p><p>SSE是一种单向通信协议，它允许服务器向客户端发送事件流。客户端通过一个持久化的HTTP连接接收事件流，这个连接可以保持打开状态，直到客户端关闭连接或服务器关闭连接。</p><p>WebSocket是一种双向通信协议，它允许服务器和客户端之间进行实时双向通信。WebSocket通过一个持久化的TCP连接实现双向通信，客户端和服务器可以随时发送消息。</p><h2 id="sse"><a href="#sse" class="headerlink" title="sse"></a>sse</h2><h3 id="1-如何保持长连接"><a href="#1-如何保持长连接" class="headerlink" title="1.如何保持长连接"></a>1.如何保持长连接</h3><p>在http 1.1下Keep-Alive模式默认开启，服务端会通过tcp协议发送一个不带数据的ack请求，确保客户端的在线。</p><h3 id="2-如何判断数据完整性"><a href="#2-如何判断数据完整性" class="headerlink" title="2.如何判断数据完整性"></a>2.如何判断数据完整性</h3><p>当客户端接收到数据后会通过判断<code>Content-Length</code>或者<code>Transfer-Encoding</code>响应头判断哪一部分是完整数据。</p><h3 id="3-客户端如何判断是sse"><a href="#3-客户端如何判断是sse" class="headerlink" title="3.客户端如何判断是sse"></a>3.客户端如何判断是sse</h3><p>通过客户端设置响应头<code>Content-type</code>为<code>text/event-stream</code>。</p><p>![image-20230519105824786](F:\project\franz-blog\source_posts\sse 的原理以及java下的简单实现\image-20230519105824786-1684465110715-1.png)</p><h3 id="java简单代码实现"><a href="#java简单代码实现" class="headerlink" title="java简单代码实现"></a>java简单代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/streaming&quot;,asyncSupported = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StreamingServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">// 设置响应内容类型为SSE</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">// 开启异步上下文</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">AsyncContext</span> <span class="variable">asyncContext</span> <span class="operator">=</span> request.startAsync();</span><br><span class="line">        <span class="comment">// 使用线程池执行任务</span></span><br><span class="line">        executorService.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                    <span class="comment">// 发送数据</span></span><br><span class="line">                    writer.write(<span class="string">&quot;data: &quot;</span> + i + <span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">                    writer.flush();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 模拟数据产生的延迟</span></span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                asyncContext.complete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭线程池</span></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果</p><p>![image-20230519110903114](F:\project\franz-blog\source_posts\sse 的原理以及java下的简单实现\image-20230519110903114-1684465747261-3.png)</p><h4 id="AsyncContext"><a href="#AsyncContext" class="headerlink" title="AsyncContext"></a>AsyncContext</h4><p>看到别人实现sse时都使用的AsyncContext，但是并不知道有啥用,查询资料后得知</p><p>使用<code>final AsyncContext asyncContext = request.startAsync();</code>可以实现Servlet 线程将请求转交给一个异步线程来执行业务处理，线程本身返回至容器，等待异步线程任务结束后可以直接生成响应数据。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;前段时间看到gpt返回时的部分输出的效果，觉得很有意思，所以研究了下是怎么实现的。&lt;/p&gt;
&lt;p&gt;主要是通过sse（Server-Sent Events）技术实现的这种效果&lt;/p&gt;
&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; t</summary>
      
    
    
    
    
    <category term="后端" scheme="https://blog.frzli.top/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="java" scheme="https://blog.frzli.top/tags/java/"/>
    
    <category term="sse" scheme="https://blog.frzli.top/tags/sse/"/>
    
  </entry>
  
  <entry>
    <title>nginx 中使用中文路径使用 try_files 的一些坑</title>
    <link href="https://blog.frzli.top/2023/04/12/nginx-%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E8%B7%AF%E5%BE%84%E4%BD%BF%E7%94%A8-try-files-%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/"/>
    <id>https://blog.frzli.top/2023/04/12/nginx-%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E6%96%87%E8%B7%AF%E5%BE%84%E4%BD%BF%E7%94%A8-try-files-%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/</id>
    <published>2023-04-12T12:38:05.000Z</published>
    <updated>2023-04-12T12:49:14.088Z</updated>
    
    <content type="html"><![CDATA[<p>nginx 配置如下</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">location</span> <span class="string">~ /download/(?&lt;filename&gt;.*) &#123;</span></span><br><span class="line">            <span class="attr">set</span> <span class="string">$bid &quot;&quot;;</span></span><br><span class="line">            <span class="attr">set</span> <span class="string">$filename $1;</span></span><br><span class="line">            <span class="attr">access_by_lua_file</span> <span class="string">lua/auth.lua;</span></span><br><span class="line">            <span class="attr">root</span> <span class="string">/toss/;</span></span><br><span class="line">            <span class="attr">try_files</span> <span class="string">/$bid/$filename /$filename =404;</span></span><br><span class="line">            <span class="attr">lua_code_cache</span> <span class="string">off;</span></span><br><span class="line">        <span class="attr">charset</span> <span class="string">utf-8;        </span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><p>当通过 <a href="http://example.com/download/%E6%B5%8B%E8%AF%95.jpg">http://example.com/download/测试.jpg</a> 时出现404 no found问题</p><p>原因是filename变量是通过urlencode后的值，nginx在磁盘中找不到该文件</p><p>解决方法: 通过access_by_lua_file解码并修改更改filename的值</p><p>核心代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">urlDecode</span><span class="params">(s)</span></span></span><br><span class="line">    s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">&#x27;%%(%x%x)&#x27;</span>, <span class="function"><span class="keyword">function</span><span class="params">(h)</span></span> <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="built_in">tonumber</span>(h, <span class="number">16</span>)) <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">ngx.var.filename = urlDecode(ngx.var.filename)</span><br></pre></td></tr></table></figure><p>如果解码之后还是出现404 no found可以使用<code>locale</code>检查一下服务器编码确定是utf-8编码，即LANG&#x3D;en_US.utf8 并且在location块配置charset utf-8;</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;nginx 配置如下&lt;/p&gt;
&lt;figure class=&quot;highlight properties&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;</summary>
      
    
    
    
    
    <category term="nginx" scheme="https://blog.frzli.top/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Openresty 实现 WebDAV 功能 ，并且实现在 WebDAV 下多用户认证以及访问目录控制 - 2</title>
    <link href="https://blog.frzli.top/2023/04/06/Openresty-%E5%AE%9E%E7%8E%B0-WebDAV-%E5%8A%9F%E8%83%BD-%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%AE%9E%E7%8E%B0%E5%9C%A8-WebDAV-%E4%B8%8B%E5%A4%9A%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%BB%A5%E5%8F%8A%E8%AE%BF%E9%97%AE%E7%9B%AE%E5%BD%95%E6%8E%A7%E5%88%B6-2/"/>
    <id>https://blog.frzli.top/2023/04/06/Openresty-%E5%AE%9E%E7%8E%B0-WebDAV-%E5%8A%9F%E8%83%BD-%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%AE%9E%E7%8E%B0%E5%9C%A8-WebDAV-%E4%B8%8B%E5%A4%9A%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%BB%A5%E5%8F%8A%E8%AE%BF%E9%97%AE%E7%9B%AE%E5%BD%95%E6%8E%A7%E5%88%B6-2/</id>
    <published>2023-04-06T03:37:28.000Z</published>
    <updated>2023-04-06T03:52:11.929Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://blog.frzli.top/2023/03/25/Openresty-%E5%AE%9E%E7%8E%B0-WebDAV-%E5%8A%9F%E8%83%BD-%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%AE%9E%E7%8E%B0%E5%9C%A8-WebDAV-%E4%B8%8B%E5%A4%9A%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%BB%A5%E5%8F%8A%E8%AE%BF%E9%97%AE%E7%9B%AE%E5%BD%95%E6%8E%A7%E5%88%B6/">关于openresty-dav的编译以及简单的webdav部署请看上文</a></p><p>在上文中我们编译了带WebDAV功能的Openresty，并且实现了简单的WebDAV功能</p><h2 id="Openresty配置文件"><a href="#Openresty配置文件" class="headerlink" title="Openresty配置文件"></a>Openresty配置文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">location ~ /dav/(?&lt;bucket_id&gt;\d+)/(?&lt;sub_path&gt;.*) &#123;</span><br><span class="line">    set $user_path &quot;&quot;;</span><br><span class="line">    set $bucket_id $1;</span><br><span class="line">    # 临时文件夹</span><br><span class="line">    client_body_temp_path /toss/tmp;</span><br><span class="line">    # webdav 支持的方式</span><br><span class="line">    dav_methods  PUT DELETE MKCOL COPY MOVE;</span><br><span class="line">    # webdav 插件支持的请求方式</span><br><span class="line">    dav_ext_methods PROPFIND OPTIONS LOCK UNLOCK;</span><br><span class="line"></span><br><span class="line">    create_full_put_path on;</span><br><span class="line">    # 访问权限</span><br><span class="line">    dav_access      user:rw group:rw  all:r;</span><br><span class="line"></span><br><span class="line">    #禁止创建文件夹</span><br><span class="line">    if ($request_method = MKCOL) &#123;</span><br><span class="line">        return 405;</span><br><span class="line">    &#125;</span><br><span class="line">    # 网页自动索引</span><br><span class="line">    autoindex on;</span><br><span class="line">    # 基于 http basic 的认证</span><br><span class="line">    auth_basic &quot;Authorized Users Only&quot;;</span><br><span class="line">    # 权限控制和 user_path 控制</span><br><span class="line">    access_by_lua_file lua/webdav_auth.lua;</span><br><span class="line">    # 设置目录</span><br><span class="line">    alias $user_path/$sub_path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以通过access_by_lua_file文件动态控制webdav访问的目录以及用户认证。</p><p>在lua file中设置$user_path以及$sub_path变量</p><p>通过http basic进行用户的认证</p><h2 id="lua脚本编写"><a href="#lua脚本编写" class="headerlink" title="lua脚本编写"></a>lua脚本编写</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> mysql = <span class="built_in">require</span>(<span class="string">&quot;resty.mysql&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> resty_sha1 = <span class="built_in">require</span>(<span class="string">&quot;resty.sha1&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> str = <span class="built_in">require</span>(<span class="string">&quot;resty.string&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> headers = ngx.req.get_headers()</span><br><span class="line"><span class="keyword">local</span> authorization = headers[<span class="string">&quot;Authorization&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> salt = <span class="string">&quot;qefd1y098ehudi&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> db, err = mysql:new()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> db <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">&quot;failed to instantiate mysql: &quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">db:set_timeout(<span class="number">1000</span>)</span><br><span class="line"><span class="keyword">local</span> ok, err, errno, sqlstate = db:connect &#123;</span><br><span class="line">    host = <span class="string">&quot;db&quot;</span>,</span><br><span class="line">    port = <span class="number">3306</span>,</span><br><span class="line">    database = <span class="string">&quot;dbname&quot;</span>,</span><br><span class="line">    user = <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    password = <span class="string">&quot;pwd&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">&quot;failed to connect: &quot;</span>, err, <span class="string">&quot;: &quot;</span>, errno, <span class="string">&quot; &quot;</span>, sqlstate)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">close_db</span><span class="params">(db)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> db <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    db:<span class="built_in">close</span>()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">(username, password)</span></span></span><br><span class="line">    <span class="keyword">local</span> sha1 = resty_sha1:new()</span><br><span class="line">    sha1:update(password)</span><br><span class="line">    sha1:update(salt)</span><br><span class="line">    <span class="keyword">local</span> digest = sha1:final()</span><br><span class="line">    <span class="keyword">local</span> pwd = <span class="built_in">tostring</span>(str.to_hex(digest))</span><br><span class="line">    <span class="keyword">local</span> quoted = ngx.quote_sql_str(<span class="built_in">tostring</span>(username))</span><br><span class="line">    <span class="keyword">local</span> sql = <span class="string">&quot;SELECT count(*) sum FROM `tb_sysuser` where `username` =  &quot;</span> ..quoted.. <span class="string">&quot;  and `password` =  &#x27;&quot;</span> ..pwd .. <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ALERT,<span class="string">&quot;sql = &quot;</span> .. sql)</span><br><span class="line">    res, err, errno, sqlstate = db:query(sql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line">        ngx.<span class="built_in">log</span>(ngx.ALERT,<span class="string">&quot;database Error \n&quot;</span> .. err)</span><br><span class="line">        close_db(db)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, row <span class="keyword">in</span> <span class="built_in">ipairs</span>(res) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">for</span> name, value <span class="keyword">in</span> <span class="built_in">pairs</span>(row) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> name == <span class="string">&quot;sum&quot;</span> <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ALERT, <span class="string">&quot;value = &quot;</span> .. value)</span><br><span class="line">                <span class="keyword">return</span> value == <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPriviledge</span><span class="params">(username)</span></span></span><br><span class="line">    <span class="keyword">local</span> quoted = ngx.quote_sql_str(<span class="built_in">tostring</span>(username))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> sql = <span class="string">&quot;select privilege from tb_bucket_privilege where bid = &quot;</span>..ngx.var.bucket_id..<span class="string">&quot; and uid = (SELECT id from tb_sysuser where username = &quot;</span>..quoted..<span class="string">&quot; )&quot;</span></span><br><span class="line"></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ALERT,<span class="string">&quot;sql = &quot;</span> .. sql)</span><br><span class="line"></span><br><span class="line">    res, err, errno, sqlstate = db:query(sql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line">        ngx.<span class="built_in">log</span>(ngx.ALERT,<span class="string">&quot;database Error \n&quot;</span> .. err)</span><br><span class="line">        close_db(db)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, row <span class="keyword">in</span> <span class="built_in">ipairs</span>(res) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">for</span> name, value <span class="keyword">in</span> <span class="built_in">pairs</span>(row) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> name == <span class="string">&quot;privilege&quot;</span> <span class="keyword">then</span></span><br><span class="line">                close_db(db)</span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ALERT, <span class="string">&quot;value = &quot;</span> .. value)</span><br><span class="line">                <span class="keyword">return</span> value == <span class="string">&quot;rw&quot;</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">fail</span><span class="params">()</span></span></span><br><span class="line">    ngx.header[<span class="string">&quot;WWW-Authenticate&quot;</span>] = <span class="string">&#x27;Basic realm=&quot;Restricted Area&quot;&#x27;</span></span><br><span class="line">    ngx.<span class="built_in">exit</span>(ngx.HTTP_UNAUTHORIZED)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> authorization <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> encoded = authorization:<span class="built_in">sub</span>(<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">local</span> decoded = ngx.decode_base64(encoded)</span><br><span class="line">    <span class="keyword">local</span> username, password = decoded:<span class="built_in">match</span>(<span class="string">&quot;([^:]*):(.*)&quot;</span>)</span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ALERT, username .. <span class="string">&quot;:&quot;</span> .. password)</span><br><span class="line">    <span class="keyword">if</span> check(username, password) <span class="keyword">then</span></span><br><span class="line">        ngx.req.set_header(<span class="string">&quot;X-User&quot;</span>, username)</span><br><span class="line">        <span class="keyword">local</span> readlPath = <span class="string">&quot;/toss/&quot;</span> .. ngx.var.bucket_id</span><br><span class="line">        ngx.<span class="built_in">log</span>(ngx.ALERT,readlPath)</span><br><span class="line">        <span class="keyword">if</span> checkPriviledge(username) <span class="keyword">then</span></span><br><span class="line">            ngx.var.user_path = readlPath</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            fail()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fail()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    fail()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>通过上述lua脚本控制访问权限和访问目录</p><p>注意上面lua脚本默认的访问根目录是 &#x2F;toss&#x2F;</p><p>通过访问mysql数据库校验权限</p>]]></content>
    
    
    <summary type="html">在 Nginx 下实现 WebDAV 功能，并且通过 lua 脚本实现 WebDAV 中用户的认证以及控制不同用户的目录访问权</summary>
    
    
    
    
    <category term="webdav" scheme="https://blog.frzli.top/tags/webdav/"/>
    
    <category term="Openresty" scheme="https://blog.frzli.top/tags/Openresty/"/>
    
    <category term="后端" scheme="https://blog.frzli.top/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="lua" scheme="https://blog.frzli.top/tags/lua/"/>
    
  </entry>
  
  <entry>
    <title>docker-compose + shell 一键化项目部署的一次尝试</title>
    <link href="https://blog.frzli.top/2023/04/05/docker-compose-shell-%E4%B8%80%E9%94%AE%E5%8C%96%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95/"/>
    <id>https://blog.frzli.top/2023/04/05/docker-compose-shell-%E4%B8%80%E9%94%AE%E5%8C%96%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95/</id>
    <published>2023-04-05T06:14:33.000Z</published>
    <updated>2023-04-05T09:46:35.927Z</updated>
    
    <content type="html"><![CDATA[<h2 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h2><p>某项目存在以下架构</p><p><img src="https://blog.frzli.top/2023/04/05/docker-compose-shell-%E4%B8%80%E9%94%AE%E5%8C%96%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95/image-20230405171010054.png" alt="image-20230405171010054"></p><p>现在需要一键部署自己添加插件编译的 openresty 添加lua脚本以及部署一个基于java的后端服务,并且实现对于java的后端服务实现实时更新的功能，并且通过 Docker Network实现容器之间的相互连接。(如果需要在一键部署中增加redis以及MySQL等等服务也是同理)</p><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h3><blockquote><p>Compose 是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose，您可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。</p></blockquote><p>通过docker-compose 可以实现创建多个容器并且控制他们的配置和他们之间的关系，本文将通过docker-compose + shell脚本实现一键化部署。</p><h3 id="Docker-Network"><a href="#Docker-Network" class="headerlink" title="Docker Network"></a>Docker Network</h3><p>在Docker中，默认情况下容器与容器、容器与外部宿主机的网络是隔离开来的。安装Docker的时候，docker会创建一个桥接器<code>docker0</code>，通过它才让容器与容器之间、与宿主机之间通信。</p><p>建议使用自定义的网桥来控制哪些容器可以相互通信，可以通过容器名来实现ip的解析。</p><p>在docker-compose.yml中添加以下配置实现创建自定义网桥并且实现容器加入网桥</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span> </span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">oss-application</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">oss-networks</span></span><br><span class="line">  <span class="attr">openresty:</span> </span><br><span class="line">  <span class="string">....</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">oss-openresty</span></span><br><span class="line">    <span class="string">....</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">oss-networks</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">oss-networks:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><h2 id="编写Openresty的Dockerfile"><a href="#编写Openresty的Dockerfile" class="headerlink" title="编写Openresty的Dockerfile"></a>编写Openresty的Dockerfile</h2><h3 id="因为要自己重新编译一遍-故base-image使用-ubuntu-22-04"><a href="#因为要自己重新编译一遍-故base-image使用-ubuntu-22-04" class="headerlink" title="因为要自己重新编译一遍 故base image使用 ubuntu:22.04"></a>因为要自己重新编译一遍 故base image使用 ubuntu:22.04</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">22.04</span></span><br></pre></td></tr></table></figure><h3 id="给docker容器里的apt换源并且安装Openresty运行与编译所需要的相关依赖"><a href="#给docker容器里的apt换源并且安装Openresty运行与编译所需要的相关依赖" class="headerlink" title="给docker容器里的apt换源并且安装Openresty运行与编译所需要的相关依赖"></a>给docker容器里的apt换源并且安装Openresty运行与编译所需要的相关依赖</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 换源</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">touch</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&quot;deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&quot;deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&quot;deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&quot;deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get clean all</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装相关依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y build-essential libpcre3-dev zlib1g-dev libssl-dev git wget perl curl libxml2 libxml2-dev libxslt-dev</span></span><br></pre></td></tr></table></figure><h3 id="编译Openresty-并添加需要的模块"><a href="#编译Openresty-并添加需要的模块" class="headerlink" title="编译Openresty 并添加需要的模块"></a>编译Openresty 并添加需要的模块</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># openresty源码并解压</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./source/openresty-1.21.4.1.tar.gz /</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> / &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar -xzvf openresty-1.21.4.1.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cd</span> openresty-1.21.4.1/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ngx_http_dav_module模块</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./source/nginx-dav-ext-module-3.0.0.tar.gz /openresty-1.21.4.1/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /openresty-1.21.4.1 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar -xzvf nginx-dav-ext-module-3.0.0.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> nginx-dav-ext-module-3.0.0 nginx-dav-ext-module</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置并编译openresty</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /openresty-1.21.4.1 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    ./configure --prefix=/usr/local/openresty \</span></span><br><span class="line"><span class="language-bash">    --with-http_dav_module \</span></span><br><span class="line"><span class="language-bash">    --add-module=nginx-dav-ext-module \</span></span><br><span class="line"><span class="language-bash">    --without-http_gzip_module &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make install</span></span><br></pre></td></tr></table></figure><p>这里添加的是http_dav_module以及nginx-dav-ext-module模块，可以根据自己的需求定制</p><h3 id="配置Openresty-相关内容"><a href="#配置Openresty-相关内容" class="headerlink" title="配置Openresty 相关内容"></a>配置Openresty 相关内容</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝配置文件和lua脚本</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf /usr/local/openresty/nginx/conf/nginx.conf &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> -p /usr/local/openresty/nginx/lua &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> -p /toss/tmp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./nginx.conf /usr/local/openresty/nginx/conf/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./lua/referer_and_down_auth.lua /usr/local/openresty/nginx/lua/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./lua/webdav_auth.lua /usr/local/openresty/nginx/lua/</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p> 这里可以拷贝一些自己要运行的脚本和nginx的配置文件，后面通过路径映射配置也是可以的</p><h3 id="运行openresty"><a href="#运行openresty" class="headerlink" title="运行openresty"></a>运行openresty</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行openresty</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/usr/local/openresty/bin/openresty&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure><h3 id="完成Dockerfile"><a href="#完成Dockerfile" class="headerlink" title="完成Dockerfile"></a>完成Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">22.04</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 换源</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">touch</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&quot;deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&quot;deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&quot;deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&quot;deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse&quot;</span> &gt;&gt; /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get clean all</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装相关依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y build-essential libpcre3-dev zlib1g-dev libssl-dev git wget perl curl libxml2 libxml2-dev libxslt-dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># openresty源码并解压</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./source/openresty-1.21.4.1.tar.gz /</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> / &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar -xzvf openresty-1.21.4.1.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cd</span> openresty-1.21.4.1/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ngx_http_dav_module模块</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./source/nginx-dav-ext-module-3.0.0.tar.gz /openresty-1.21.4.1/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /openresty-1.21.4.1 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    tar -xzvf nginx-dav-ext-module-3.0.0.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mv</span> nginx-dav-ext-module-3.0.0 nginx-dav-ext-module</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置并编译openresty</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /openresty-1.21.4.1 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    ./configure --prefix=/usr/local/openresty \</span></span><br><span class="line"><span class="language-bash">    --with-http_dav_module \</span></span><br><span class="line"><span class="language-bash">    --add-module=nginx-dav-ext-module \</span></span><br><span class="line"><span class="language-bash">    --without-http_gzip_module &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    make install</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝配置文件和lua脚本</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -rf /usr/local/openresty/nginx/conf/nginx.conf &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> -p /usr/local/openresty/nginx/lua &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">mkdir</span> -p /toss/tmp</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./nginx.conf /usr/local/openresty/nginx/conf/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./lua/referer_and_down_auth.lua /usr/local/openresty/nginx/lua/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./lua/webdav_auth.lua /usr/local/openresty/nginx/lua/</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行openresty</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/usr/local/openresty/bin/openresty&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="编写java应用后端的Dockerfile"><a href="#编写java应用后端的Dockerfile" class="headerlink" title="编写java应用后端的Dockerfile"></a>编写java应用后端的Dockerfile</h2><p>这一部分网上很多相似的配置文件没什么好说的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># java 环境</span><br><span class="line">FROM openjdk:<span class="number">17</span>-jdk-slim</span><br><span class="line"># 定义工作目录</span><br><span class="line">WORKDIR /</span><br><span class="line"># 把项目中的所有东西复制到工作目录(app)下面 (这里可以改成自己的jar包)</span><br><span class="line">COPY ./f-oss-<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT.jar /</span><br><span class="line"># 改变容器的时区</span><br><span class="line">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">RUN echo <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span><br><span class="line">#端口号 （这里可以改成自己的运行命令）</span><br><span class="line">ENTRYPOINT [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/f-oss-0.0.1-SNAPSHOT.jar&quot;</span>,<span class="string">&quot;--spring.profiles.active=pro&quot;</span>]</span><br></pre></td></tr></table></figure><h2 id="通过docker-compose-yml部署"><a href="#通过docker-compose-yml部署" class="headerlink" title="通过docker-compose.yml部署"></a>通过docker-compose.yml部署</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span> </span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./application</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">oss-application</span></span><br><span class="line">    <span class="attr">dns:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">223.6</span><span class="number">.6</span><span class="number">.6</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/toss:/toss:rw</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">oss-networks</span></span><br><span class="line">  <span class="attr">openresty:</span> </span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./openresty</span></span><br><span class="line">    <span class="comment"># image: openresty-dav:0.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">12345</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">oss-openresty</span></span><br><span class="line">    <span class="attr">dns:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">223.6</span><span class="number">.6</span><span class="number">.6</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/toss:/toss:rw</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">oss-networks</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">oss-networks:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>目录结构</p><blockquote><p>│  docker-compose.yml<br>│  install.sh<br>│<br>├─application<br>│      Dockerfile<br>│      f-oss-0.0.1-SNAPSHOT.jar<br>│<br>└─openresty<br>    │  Dockerfile<br>    │  nginx.conf<br>    │<br>    ├─lua<br>    │      referer_and_down_auth.lua<br>    │      webdav_auth.lua<br>    │<br>    └─source<br>            nginx-dav-ext-module-3.0.0.tar.gz<br>            openresty-1.21.4.1.tar.gz</p></blockquote><p>在上面的 docker-compose 中将会自动从两个dockerfile中构建docker image，运行，实现目录挂载，端口映射，加入网桥等等操作</p><p>通过运行 <code>docker-compose up</code>可以看到两个docker container已经被成功拉起</p><p><img src="https://blog.frzli.top/2023/04/05/docker-compose-shell-%E4%B8%80%E9%94%AE%E5%8C%96%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95/image-20230405173539481.png" alt="image-20230405173539481"></p><p><img src="https://blog.frzli.top/2023/04/05/docker-compose-shell-%E4%B8%80%E9%94%AE%E5%8C%96%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E7%9A%84%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95/image-20230405173548489.png" alt="image-20230405173548489"></p><h2 id="shell-脚本的引入"><a href="#shell-脚本的引入" class="headerlink" title="shell 脚本的引入"></a>shell 脚本的引入</h2><p>通过上面的部署发现当java后端应用更新之后要手动更新重新构建之后的f-oss-0.0.1-SNAPSHOT.jar，从而实现容器中的应用更新。</p><p>我们可以通过实现shell脚本实现每次启动时检查更新，并且自动替换f-oss-0.0.1-SNAPSHOT.jar，重新构建镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Check <span class="keyword">if</span> Docker Compose is installed</span></span><br><span class="line">if ! [ -x &quot;$(command -v docker-compose)&quot; ]; then</span><br><span class="line">  echo &#x27;Error: docker-compose is not installed.&#x27; &gt;&amp;2</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Check <span class="keyword">if</span> wget is installed</span></span><br><span class="line">if ! [ -x &quot;$(command -v wget)&quot; ]; then</span><br><span class="line">  echo &#x27;Error: wget is not installed.&#x27; &gt;&amp;2</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if 检查更新逻辑 then</span><br><span class="line">下载最新版 f-oss-0.0.1-SNAPSHOT.jar</span><br><span class="line">docker-compose build (你的service name)</span><br><span class="line"> fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉起容器</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">又是当运维的一天</summary>
    
    
    
    
    <category term="运维" scheme="https://blog.frzli.top/tags/%E8%BF%90%E7%BB%B4/"/>
    
    <category term="docker" scheme="https://blog.frzli.top/tags/docker/"/>
    
    <category term="docker-compose" scheme="https://blog.frzli.top/tags/docker-compose/"/>
    
  </entry>
  
  <entry>
    <title>一次线上事故的反思-MySQL中order by与limit一起使用的坑</title>
    <link href="https://blog.frzli.top/2023/03/29/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85%E7%9A%84%E5%8F%8D%E6%80%9D-MySQL%E4%B8%ADorder-by%E4%B8%8Elimit%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9D%91/"/>
    <id>https://blog.frzli.top/2023/03/29/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85%E7%9A%84%E5%8F%8D%E6%80%9D-MySQL%E4%B8%ADorder-by%E4%B8%8Elimit%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9D%91/</id>
    <published>2023-03-29T01:11:36.000Z</published>
    <updated>2023-03-29T06:38:01.663Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题场景"><a href="#问题场景" class="headerlink" title="问题场景"></a>问题场景</h2><p>一个新项目提供了一个查询所有Bucket的接口，同时使用了Order By 和 limit 同时进行排序和分页查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"><span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">tb_bucket </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">uid <span class="operator">=</span> $&#123;userId&#125; </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">create_time <span class="keyword">DESC</span> </span><br><span class="line">    limit $&#123;(page <span class="operator">-</span> <span class="number">1</span>)<span class="operator">*</span>size&#125;, #&#123;size&#125;</span><br></pre></td></tr></table></figure><p>上线后前端反馈数据出现来回跳动，数据一会出现在第一页一会出现在第二页，导致数据一部分缺失一部分重复</p><p><img src="https://blog.frzli.top/2023/03/29/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85%E7%9A%84%E5%8F%8D%E6%80%9D-MySQL%E4%B8%ADorder-by%E4%B8%8Elimit%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9D%91/image-20230329092527083.png" alt="image-20230329092527083"></p><p><img src="https://blog.frzli.top/2023/03/29/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85%E7%9A%84%E5%8F%8D%E6%80%9D-MySQL%E4%B8%ADorder-by%E4%B8%8Elimit%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9D%91/image-20230329092538575.png" alt="image-20230329092538575"></p><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>发生问题后首先检查了一遍代码逻辑，并未发现其他问题，当把SQL拿出来单独执行的时候出现了数据错误的问题。发现出现数据错误的数据都有相同的create_time，而SQL又是基于create_time排序的，故怀疑order by 和 limit 同时使用的问题。<strong>以create_time进行降序排序，当create_time存在多条重复时基于limit分页出现数据错误问题。</strong></p><p>查阅了MySQL的官方文档发现的MySQL limit的查询优化所导致</p><blockquote><p>If multiple rows have identical values in the <code>ORDER BY</code> columns, the server is free to return those rows in any order, and may do so differently depending on the overall execution plan. In other words, the sort order of those rows is nondeterministic with respect to the nonordered columns</p></blockquote><p>大意就是<strong>如果多个行在“ORDER BY”列中具有相同的值，服务器可以自由地以任何顺序返回这些行，并且可能会根据整体执行计划以不同的方式返回。换句话说，这些行的排序顺序相对于未排序的列是不确定的</strong>。</p><p><a href="https://dev.mysql.com/doc/refman/8.0/en/limit-optimization.html">MySQL 官方文档原文</a></p><h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>解决思路是：避免ORDER BY列的值出现重复。因此，可以加入排序列，比如id等等。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"><span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">tb_bucket </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">uid <span class="operator">=</span> $&#123;userId&#125; </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">create_time <span class="keyword">DESC</span> id <span class="keyword">ASC</span></span><br><span class="line">    limit $&#123;(page <span class="operator">-</span> <span class="number">1</span>)<span class="operator">*</span>size&#125;, #&#123;size&#125;</span><br></pre></td></tr></table></figure><p>加入id作为排序条件后，数据混乱的问题解决</p><p><img src="https://blog.frzli.top/2023/03/29/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85%E7%9A%84%E5%8F%8D%E6%80%9D-MySQL%E4%B8%ADorder-by%E4%B8%8Elimit%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9D%91/image-20230329142622876.png" alt="image-20230329142622876"></p><p><img src="https://blog.frzli.top/2023/03/29/%E4%B8%80%E6%AC%A1%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85%E7%9A%84%E5%8F%8D%E6%80%9D-MySQL%E4%B8%ADorder-by%E4%B8%8Elimit%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9D%91/image-20230329142652385.png" alt="image-20230329142652385"></p>]]></content>
    
    
    <summary type="html">一次线上事故的反思-MySQL中order by与limit一起使用的坑</summary>
    
    
    
    
    <category term="后端" scheme="https://blog.frzli.top/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="MySQL" scheme="https://blog.frzli.top/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Openresty 实现 WebDAV 功能 ，并且实现在 WebDAV 下多用户认证以及访问目录控制</title>
    <link href="https://blog.frzli.top/2023/03/25/Openresty-%E5%AE%9E%E7%8E%B0-WebDAV-%E5%8A%9F%E8%83%BD-%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%AE%9E%E7%8E%B0%E5%9C%A8-WebDAV-%E4%B8%8B%E5%A4%9A%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%BB%A5%E5%8F%8A%E8%AE%BF%E9%97%AE%E7%9B%AE%E5%BD%95%E6%8E%A7%E5%88%B6/"/>
    <id>https://blog.frzli.top/2023/03/25/Openresty-%E5%AE%9E%E7%8E%B0-WebDAV-%E5%8A%9F%E8%83%BD-%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%AE%9E%E7%8E%B0%E5%9C%A8-WebDAV-%E4%B8%8B%E5%A4%9A%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%BB%A5%E5%8F%8A%E8%AE%BF%E9%97%AE%E7%9B%AE%E5%BD%95%E6%8E%A7%E5%88%B6/</id>
    <published>2023-03-25T12:26:54.000Z</published>
    <updated>2023-03-25T13:39:43.793Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0-介绍"><a href="#0-介绍" class="headerlink" title="0.介绍"></a>0.介绍</h2><blockquote><p>基于Web的分布式编写和版本控制（WebDAV）是超文本传输协议（HTTP）的扩展，有利于用户间协同编辑和管理存储在万维网服务器文档。WebDAV由互联网工程任务组的工作组在RFC 4918中定义。<br>WebDAV协议为用户在服务器上创建、更改和移动文档提供了一个框架。WebDAV协议最重要的功能包括维护作者或修改日期的属性、名字空间管理、集合和覆盖保护。维护属性包括创建、删除和查询文件信息等。名字空间管理处理在服务器名称空间内复制和移动网页的能力。集合（Collections）处理各种资源的创建、删除和列举 (from wikipedia)  <a href="https://zh.wikipedia.org/zh-cn/%E5%9F%BA%E4%BA%8EWeb%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%96%E5%86%99%E5%92%8C%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6">wikipedia</a> </p></blockquote><p>nginx 中的 <a href="http://nginx.org/en/docs/http/ngx_http_dav_module.html">ngx_http_dav_module</a> 模块提供了该功能的支持，<a href="https://github.com/arut/nginx-dav-ext-module">nginx-dav-ext-module</a> 主要是实现了 NGINX WebDAV 未实现的命令支持，包括：PROPFIND &amp; OPTIONS 对于完整的 WebDAV 支持</p><p>通过 windows 自带的网络驱动器映射可以实现以下效果</p><p><img src="https://blog.frzli.top/2023/03/25/Openresty-%E5%AE%9E%E7%8E%B0-WebDAV-%E5%8A%9F%E8%83%BD-%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%AE%9E%E7%8E%B0%E5%9C%A8-WebDAV-%E4%B8%8B%E5%A4%9A%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%BB%A5%E5%8F%8A%E8%AE%BF%E9%97%AE%E7%9B%AE%E5%BD%95%E6%8E%A7%E5%88%B6/image-20230325204817756.png" alt="image-20230325204817756"></p><h2 id="1-Openresty-的编译与安装"><a href="#1-Openresty-的编译与安装" class="headerlink" title="1.Openresty 的编译与安装"></a>1.Openresty 的编译与安装</h2><p>OpenResty 是一个基于 Nginx 的 Web 平台，整合了诸如 LuaJIT、LuaNginxModule 等模块,所以我们用 Openresty 代替 nginx</p><p>因为webdav需要 ngx_http_dav_module 以及 nginx-dav-ext-module 的支持 ，所以我们要自己编译自己的Openresty </p><p><strong>环境 Ubuntu 22.04</strong></p><h3 id="1-1-Openresty-源代码下载"><a href="#1-1-Openresty-源代码下载" class="headerlink" title="1.1 Openresty 源代码下载"></a>1.1 Openresty 源代码下载</h3><p>通过 <a href="https://openresty.org/cn/download.html">Openresty 官方网站</a>获取最新的源代码并且解压</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://openresty.org/download/openresty-1.21.4.1.tar.gz</span><br><span class="line">tar -xzvf openresty-1.21.4.1.tar.gz</span><br></pre></td></tr></table></figure><h3 id="1-2-开发依赖安装"><a href="#1-2-开发依赖安装" class="headerlink" title="1.2 开发依赖安装"></a>1.2 开发依赖安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line"></span><br><span class="line">apt-get install libpcre3-dev \</span><br><span class="line">    libssl-dev perl make build-essential curl \</span><br><span class="line">    libxml2 libxml2-dev libxslt-dev</span><br></pre></td></tr></table></figure><h3 id="1-3-下载-nginx-dav-ext-module-并且配置编译时所添加的module"><a href="#1-3-下载-nginx-dav-ext-module-并且配置编译时所添加的module" class="headerlink" title="1.3 下载 nginx-dav-ext-module 并且配置编译时所添加的module"></a>1.3 下载 nginx-dav-ext-module 并且配置编译时所添加的module</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> openresty-1.21.4.1</span><br><span class="line"></span><br><span class="line">wget https://codeload.github.com/arut/nginx-dav-ext-module/tar.gz/refs/tags/v3.0.0 -O nginx-dav-ext-module.tar.gz</span><br><span class="line"></span><br><span class="line">tar -xzvf nginx-dav-ext-module.tar.gz</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/openresty \</span><br><span class="line">            --with-http_dav_module \</span><br><span class="line">            --add-module=nginx-dav-ext-module \</span><br><span class="line">            --without-http_gzip_module </span><br></pre></td></tr></table></figure><h3 id="1-4-编译并且安装"><a href="#1-4-编译并且安装" class="headerlink" title="1.4 编译并且安装"></a>1.4 编译并且安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gmake</span><br><span class="line"></span><br><span class="line">gmake install </span><br></pre></td></tr></table></figure><p>执行上述命令后会发现 Openresty 已经安装在 &#x2F;usr&#x2F;local&#x2F;openresty 但是 openresty 命令还是不可用,可以通过添加软连接实现可以在任意文件夹使用 openresty 命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/openresty/bin</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">ln</span> -s `<span class="built_in">pwd</span>`/openresty /usr/local/bin/openresty</span><br><span class="line">sudo <span class="built_in">ln</span> -s `<span class="built_in">pwd</span>`/opm /usr/local/bin/opm</span><br></pre></td></tr></table></figure><p>运行 Openresty 访问 <a href="http://localhost/">http://localhost</a> 将会出现 Welcome to OpenResty! 字样，代表 OpenResty 已经安装成功!</p><p><img src="https://blog.frzli.top/2023/03/25/Openresty-%E5%AE%9E%E7%8E%B0-WebDAV-%E5%8A%9F%E8%83%BD-%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%AE%9E%E7%8E%B0%E5%9C%A8-WebDAV-%E4%B8%8B%E5%A4%9A%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%BB%A5%E5%8F%8A%E8%AE%BF%E9%97%AE%E7%9B%AE%E5%BD%95%E6%8E%A7%E5%88%B6/image-20230325205506326.png" alt="image-20230325205506326"></p><h2 id="2-最简单的-Webdav-实现"><a href="#2-最简单的-Webdav-实现" class="headerlink" title="2. 最简单的 Webdav 实现"></a>2. 最简单的 Webdav 实现</h2><p>修改配置文件 <code>/usr/local/openresty/nginx/conf/nginx.conf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">... # 你自己的某些配置</span><br><span class="line"> </span><br><span class="line">    server &#123;</span><br><span class="line">        ...</span><br><span class="line"> </span><br><span class="line">        location / &#123;</span><br><span class="line">        # webdav 访问的根目录 ，暂时使用root </span><br><span class="line">            root /www/wwwroot/webdav; </span><br><span class="line">    # 文件暂存地址</span><br><span class="line">            client_body_temp_path /www/wwwroot/webdav/client_temp; </span><br><span class="line"> # webdav 支持的方法</span><br><span class="line">            dav_methods PUT DELETE MKCOL COPY MOVE;</span><br><span class="line">            dav_ext_methods PROPFIND OPTIONS LOCK UNLOCK;</span><br><span class="line">            </span><br><span class="line">            create_full_put_path on;</span><br><span class="line">            dav_accessuser:rw group:rw  all:r;</span><br><span class="line"> # 网页页面自动索引文件</span><br><span class="line">            autoindex on;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样可以实现最基本的无认证，无动态目录WebDAV </p><p>这篇我们编译了带实现 webdav module支持的openresy ，并且实现了最简单的WebDAV，下一篇将会通过编写lua脚本实现多用户认证，以及动态控制访问目录的功能（应该会很快写出来）</p>]]></content>
    
    
    <summary type="html">在 Nginx 下实现 WebDAV 功能，并且通过 lua 脚本实现 WebDAV 中用户的认证以及控制不同用户的目录访问权</summary>
    
    
    
    
    <category term="webdav" scheme="https://blog.frzli.top/tags/webdav/"/>
    
    <category term="Openresty" scheme="https://blog.frzli.top/tags/Openresty/"/>
    
    <category term="后端" scheme="https://blog.frzli.top/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="lua" scheme="https://blog.frzli.top/tags/lua/"/>
    
  </entry>
  
  <entry>
    <title>基础算法-二分答案</title>
    <link href="https://blog.frzli.top/2023/03/21/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95-%E4%BA%8C%E5%88%86%E7%AD%94%E6%A1%88/"/>
    <id>https://blog.frzli.top/2023/03/21/%E5%9F%BA%E7%A1%80%E7%AE%97%E6%B3%95-%E4%BA%8C%E5%88%86%E7%AD%94%E6%A1%88/</id>
    <published>2023-03-21T08:01:12.000Z</published>
    <updated>2023-03-21T12:09:48.498Z</updated>
    
    <content type="html"><![CDATA[<h2 id="二分答案："><a href="#二分答案：" class="headerlink" title="二分答案："></a>二分答案：</h2><blockquote><p>解题的时候往往会考虑枚举答案然后检验枚举的值是否正确。若满足单调性，则满足使用二分法的条件。把这里的枚举换成二分，就变成了「二分答案」。<a href="https://oi-wiki.org/basic/binary/#%E4%BA%8C%E5%88%86%E7%AD%94%E6%A1%88">OI-WIKI</a></p></blockquote><h2 id="二分答案模板"><a href="#二分答案模板" class="headerlink" title="二分答案模板"></a>二分答案模板</h2><h3 id="寻找-gt-x3D-的最小值"><a href="#寻找-gt-x3D-的最小值" class="headerlink" title="寻找 &gt;&#x3D; 的最小值"></a>寻找 &gt;&#x3D; 的最小值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">bserach_l</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> r, <span class="type">int</span> x)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> l + ((r - l) &gt;&gt; <span class="number">1</span>); <span class="comment">// 防止溢出</span></span><br><span class="line">        <span class="keyword">if</span> (check(mid))</span><br><span class="line">            r = mid;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="寻找-lt-x3D-的模板"><a href="#寻找-lt-x3D-的模板" class="headerlink" title="寻找 &lt;&#x3D; 的模板"></a>寻找 &lt;&#x3D; 的模板</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">bserach_l</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> r, <span class="type">int</span> x)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> l + ((r - l) &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>; <span class="comment">// 防止溢出</span></span><br><span class="line">        <span class="keyword">if</span> (check(mid))</span><br><span class="line">            r = mid;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            l = mid - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><p>例题 <a href="https://www.luogu.com.cn/problem/P2440">P2440 木材加工</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> n,k;</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        n = sc.nextInt();</span><br><span class="line">        k = sc.nextInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            arr[i] = sc.nextInt();</span><br><span class="line">            max = Math.max(max,arr[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> <span class="number">1</span> , r = max;</span><br><span class="line">        <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxVal</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(l &lt;  r)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> l + ((r - l) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">            val = getChunkNums(arr,mid);</span><br><span class="line">            <span class="keyword">if</span> (val &lt; k)&#123;</span><br><span class="line">                r = mid;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                l = mid + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (mid &gt;= res)&#123;</span><br><span class="line">                    res = mid;</span><br><span class="line">                    maxVal = val;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(maxVal &gt;= k ? res : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getChunkNums</span><span class="params">(<span class="type">int</span>[] arr,<span class="type">int</span> l)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i1</span> <span class="operator">=</span> <span class="number">0</span>; i1 &lt; arr.length; i1++) &#123;</span><br><span class="line">            res += arr[i1] / l;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">二分答案的模板与例题</summary>
    
    
    
    
    <category term="算法" scheme="https://blog.frzli.top/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>go学习笔记和一些语法糖</title>
    <link href="https://blog.frzli.top/2023/03/21/go%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>https://blog.frzli.top/2023/03/21/go%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</id>
    <published>2023-03-21T07:23:10.000Z</published>
    <updated>2023-03-21T13:44:42.665Z</updated>
    
    <content type="html"><![CDATA[<h3 id="…-的用法"><a href="#…-的用法" class="headerlink" title="… 的用法"></a>… 的用法</h3><h4 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">(args ...<span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, val := <span class="keyword">range</span> args &#123;</span><br><span class="line"><span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="打散slice"><a href="#打散slice" class="headerlink" title="打散slice"></a>打散slice</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := []<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">    b(s...)  <span class="comment">// 这里的slice &#123;1，2，3&#125; 被打散为 1，2，3 传入函数b</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">b</span><span class="params">(args2 ...<span class="type">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, i := <span class="keyword">range</span> args2 &#123;</span><br><span class="line"><span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="go中的继承"><a href="#go中的继承" class="headerlink" title="go中的继承"></a>go中的继承</h3><p>先看一段代码</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> (</span><br><span class="line">RouterGroup <span class="keyword">struct</span> &#123;</span><br><span class="line">prefix      <span class="type">string</span></span><br><span class="line">middlewares []HandlerFunc</span><br><span class="line">parent      *RouterGroup</span><br><span class="line">engine      *Engine</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Engine <span class="keyword">struct</span> &#123;</span><br><span class="line">*RouterGroup</span><br><span class="line">router *router</span><br><span class="line">groups []*RouterGroup</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>可以看到上面<code>Engine</code>中包含了<code>*RouterGroup</code>这一匿名字段，<code>Engine</code> 结构体将直接继承 <code>RouterGroup</code> 中的所有字段和方法，并且不需要使用 <code>.prefix</code>、<code>.middlewares</code>、<code>.parent</code> 等字段来引用 <code>RouterGroup</code> 中的属性和方法，而可以直接使用 <code>Engine</code> 实例进行访问。</p><h3 id="go-tag"><a href="#go-tag" class="headerlink" title="go tag"></a>go tag</h3><p>tag 是一种结构化的注释方式，它可以用于给结构体字段添加元数据，例如字段的名称、类型、格式、验证规则等信息。</p><p>示例如下</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span> <span class="string">`json:&quot;name&quot; xml:&quot;name&quot;`</span></span><br><span class="line">    Age  <span class="type">int</span>    <span class="string">`json:&quot;age&quot; xml:&quot;age&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以最终通过反射拿到tag的k-v信息</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span> <span class="string">`json:&quot;name&quot; xml:&quot;name&quot;`</span></span><br><span class="line">    Age  <span class="type">int</span>    <span class="string">`json:&quot;age&quot; xml:&quot;age&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    p := Person&#123;Name: <span class="string">&quot;Alice&quot;</span>, Age: <span class="number">25</span>&#125;</span><br><span class="line">    t := reflect.TypeOf(p)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; t.NumField(); i++ &#123;</span><br><span class="line">        field := t.Field(i)</span><br><span class="line">        tag := field.Tag</span><br><span class="line">        fmt.Printf(<span class="string">&quot;Field: %s, JSON tag: %s, XML tag: %s\n&quot;</span>,</span><br><span class="line">            field.Name, tag.Get(<span class="string">&quot;json&quot;</span>), tag.Get(<span class="string">&quot;xml&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cap和len"><a href="#cap和len" class="headerlink" title="cap和len"></a>cap和len</h3><p><code>cap</code> 和 <code>len</code> 都是内置函数，用于获取切片、数组、map 和 channel 的长度和容量信息。</p><p>slice作为一个array的引用其cap和len并不一定相等，slice的容量可以动态扩展，如果在使用 <code>append</code> 函数将元素添加到切片时长度超过了当前容量，Go 会动态分配一块更大的内存作为底层数组，并将原有数据复制到新的内存空间中，完成切片的扩容过程。如果切片的长度没有超过容量，则不会进行扩容。这个过程会导致切片的地址发生变化。可以通过对比改变前后切片的地址来判断是否扩容。</p><h3 id="any"><a href="#any" class="headerlink" title="any"></a>any</h3><p>在go1.18之后添加的新关键字 <a href="https://github.com/golang/go/issues/49884">all: rewrite <code>interface&#123;&#125;</code> to <code>any</code> #49884</a></p><p>等同于之前的interface{} </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> any <span class="keyword">interface</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>用法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">(v any)</span></span> &#123;</span><br><span class="line"><span class="keyword">switch</span> v.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="type">int</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;int type val&quot;</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="type">bool</span>:</span><br><span class="line">fmt.Println(<span class="string">&quot;bool type val&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">go学习过程中的一些知识点</summary>
    
    
    
    
    <category term="后端" scheme="https://blog.frzli.top/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="go" scheme="https://blog.frzli.top/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot创建自己的Start</title>
    <link href="https://blog.frzli.top/2023/03/05/SpringBoot%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84Starter/"/>
    <id>https://blog.frzli.top/2023/03/05/SpringBoot%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84Starter/</id>
    <published>2023-03-05T13:33:26.000Z</published>
    <updated>2023-03-21T07:26:00.489Z</updated>
    
    <content type="html"><![CDATA[<ol><li><p>创建SpringBoot项目</p><p>包含以下依赖</p></li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">&lt;!--自动生成meta-data--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">         </span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li><p>修改<code>pom.xml</code></p><p>修改pom.xml为对应项目名称 </p><p>starter推荐命名 xxxxx-start</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.frz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>frzApi-client-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>frzApi-client-sdk<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>frzApi-client-sdk<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>编写<code>AutoConfiguration</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;frzapi.client&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FrzApiClientConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FrzApiClient <span class="title function_">frzApiClient</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FrzApiClient</span>(accessKey, secretKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过<code>ConfigurationProperties</code>注解能够读取application 中的配置属性</p></li><li><p>配置<code>EnableAutoConfiguration</code></p><p>在<code>resource/META-INF</code>创建<code>spring.factories</code>文件,设置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">xxx</span></span><br></pre></td></tr></table></figure><blockquote><p>xxx为配置类Reference</p></blockquote></li></ol><p><img src="/2023/03/05/SpringBoot%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84Starter/im1.png" alt="目录结构" title="目录结构"></p><p>通过maven install 后即成功安装到本地maven仓库</p><p>在其他项目的依赖中添加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.frz<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>frzApi-client-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>既可以正常使用</p>]]></content>
    
    
    <summary type="html">开发API开放平台，提供java对应的客户端SDK</summary>
    
    
    
    
    <category term="后端" scheme="https://blog.frzli.top/tags/%E5%90%8E%E7%AB%AF/"/>
    
    <category term="sprigboot" scheme="https://blog.frzli.top/tags/sprigboot/"/>
    
    <category term="java" scheme="https://blog.frzli.top/tags/java/"/>
    
  </entry>
  
</feed>
